---
name: multi-package-chaining
status: backlog
created: 2025-09-18T22:32:09Z
progress: 0%
prd: .claude/prds/multi-package-chaining.md
github: https://github.com/choufeng/quick-functions/issues/1
---

# Epic: 多包联动支持系统

## 项目概述

基于现有 devup 系统，通过函数式重构扩展支持 Package A → Package B → App C 的链式依赖构建。核心策略是**最大化复用现有代码**，通过组合式设计将单包操作扩展为链式操作，避免重写已有的稳定功能。

## 架构决策

### 核心设计原则
- **增量扩展**：基于现有 devup-functions.sh 进行扩展，不破坏现有API
- **函数式组合**：将现有单包函数组合成链式操作，避免代码重复
- **配置驱动**：扩展现有JSON配置格式，添加 `type: "chain"` 支持
- **向后兼容**：现有单包配置继续正常工作

### 技术选择
- **Shell脚本**：继续使用bash，与现有系统保持一致
- **JSON配置**：扩展现有 devup-configs.json 格式
- **依赖工具**：复用现有 pnpm、jq、find 工具链
- **版本策略**：沿用 alpha + timestamp 缓存避免机制

### 设计模式
- **策略模式**：单包和链式构建使用不同策略
- **组合模式**：将单包操作函数组合成链式操作
- **管道模式**：配置 → 验证 → 解析 → 构建 → 部署

## 技术实现方案

### 配置系统扩展
基于现有配置文件格式，添加链式支持：
```json
{
  "configs": [
    {
      "name": "package-chain",
      "description": "A→B→C 依赖链",
      "type": "chain",
      "chain": [
        {
          "type": "package",
          "name": "package-a",
          "package_dir": "$HOME/dev/package-a",
          "package_name": "@scope/package-a",
          "build_command": "./pnpm run build"
        },
        {
          "type": "package", 
          "name": "package-b",
          "package_dir": "$HOME/dev/package-b",
          "package_name": "@scope/package-b",
          "build_command": "./pnpm run build",
          "dependencies": ["package-a"]
        },
        {
          "type": "app",
          "name": "app-c",
          "app_dir": "$HOME/dev/app-c",
          "start_command": "./pnpm start",
          "dependencies": ["package-b"]
        }
      ]
    }
  ]
}
```

### 核心算法实现
1. **依赖解析**：拓扑排序确定构建顺序
2. **循环依赖检测**：深度优先搜索检测环
3. **增量构建**：基于时间戳智能跳过未变更的包

### 函数式重构
重构现有函数为纯函数，便于组合：
- `build_single_package()` - 纯函数版本的单包构建
- `validate_chain_config()` - 链式配置验证
- `resolve_build_order()` - 依赖顺序解析
- `execute_chain_build()` - 链式构建协调器

## 实施策略

### 开发阶段
1. **配置解析扩展**（1-2天）
2. **依赖算法实现**（2-3天）
3. **构建流程重构**（3-4天）
4. **集成测试验证**（1-2天）

### 风险缓解
- **复杂度管理**：严格限制链长度为3级，避免过度设计
- **性能保证**：实现增量构建，只重建变更的包
- **错误处理**：详细的日志和回滚机制

### 测试方法
- **单元测试**：所有新增纯函数的独立测试
- **集成测试**：A→B→C 完整链路测试
- **兼容性测试**：确保现有单包配置正常工作

## 任务分解预览

基于最小化实现原则，识别的核心任务：

- [ ] **配置解析扩展**：扩展 `_devup_load_config()` 支持链式配置
- [ ] **依赖解析算法**：实现拓扑排序和循环依赖检测
- [ ] **构建函数重构**：将现有构建逻辑重构为可组合的纯函数
- [ ] **链式构建协调器**：实现 `devup_chain()` 主函数
- [ ] **命令行接口扩展**：添加 `-chain-*` 命令支持
- [ ] **错误处理优化**：增强错误上下文和回滚机制
- [ ] **集成测试开发**：创建端到端测试场景
- [ ] **文档更新**：更新用户文档和配置示例

## 依赖关系

### 外部依赖
- **系统工具**：pnpm, jq, find（已存在）
- **运行环境**：Node.js 16+, macOS/Linux（已满足）
- **文件系统**：足够的磁盘空间存储临时包文件

### 内部依赖
- **现有 devup 系统**：基础构建功能（已实现）
- **配置管理**：现有JSON配置解析（已实现）
- **版本管理**：alpha + timestamp 策略（已实现）

### 阻塞依赖
- 无阻塞依赖，可立即开始开发

## 成功标准（技术）

### 性能基准
- **依赖解析时间**：< 1秒（3级链）
- **增量构建性能**：比全量构建快 60%+
- **内存使用**：相比现有系统增加 < 20%

### 质量门禁
- **单元测试覆盖率**：新增代码 > 90%
- **集成测试通过率**：100%
- **向后兼容性**：现有配置无需修改即可使用

### 验收标准
- **功能完整性**：支持 A→B→C 三级依赖链配置和构建
- **错误处理**：循环依赖检测准确率 100%
- **构建成功率**：> 95%（排除用户代码错误）

## 预估工作量

### 总体时间线
- **开发阶段**：7-10天
- **测试验证**：2-3天
- **文档整理**：1-2天
- **总计**：10-15天

### 资源需求
- **开发者**：1名全职开发者
- **测试环境**：本地多包模拟环境
- **代码审查**：技术lead进行架构审查

### 关键路径
1. 配置解析扩展（前置条件）
2. 依赖解析算法（核心功能）
3. 构建流程重构（主要工作量）
4. 集成测试验证（质量保证）

## 技术债务和后续优化

### 立即范围外
- 支持4级以上依赖链
- 图形化依赖可视化
- 构建性能监控

### 未来考虑
- 并行构建非依赖包
- 智能增量检测优化
- 云端构建支持

这个实施方案通过最大化复用现有代码，以最小的改动实现最大的功能扩展，确保系统稳定性的同时提供强大的多包联动能力。

## 任务创建总结

### 批次3 - 验证层任务 (已创建)

已成功创建验证层的2个任务文件：

#### 任务007 - 集成测试开发
- **文件**: `/Users/jia.xia/development/quick-functions/.conductor/choufeng-columbus/.claude/epics/multi-package-chaining/007.md`
- **状态**: pending
- **优先级**: high
- **预估**: 4小时
- **依赖**: [004, 005, 006]
- **并行**: false (需要完整功能)
- **核心内容**:
  - 端到端测试场景创建
  - A→B→C 完整链路验证
  - 循环依赖检测测试
  - 错误处理和回滚机制验证
  - 模拟多包测试环境搭建

#### 任务008 - 文档更新
- **文件**: `/Users/jia.xia/development/quick-functions/.conductor/choufeng-columbus/.claude/epics/multi-package-chaining/008.md`
- **状态**: pending
- **优先级**: medium  
- **预估**: 3小时
- **依赖**: [005]
- **并行**: true (可与测试并行)
- **核心内容**:
  - 用户文档和配置示例更新
  - 链式配置指南创建
  - devup 命令帮助文档更新
  - 故障排除指南添加

### 完整任务体系

至此，multi-package-chaining epic 的8个任务已全部创建完成：

**基础层** (可并行):
- 001 - 配置解析扩展
- 002 - 依赖解析算法
- 003 - 构建函数重构

**协调层** (依次执行):
- 004 - 链式构建协调器
- 005 - 命令行接口扩展
- 006 - 错误处理优化

**验证层** (验证完整):
- 007 - 集成测试开发 (需完整功能)
- 008 - 文档更新 (可并行进行)

### 任务依赖关系图

```
001 ──┐
002 ──┼──→ 004 ──→ 005 ──┬──→ 007
003 ──┘         └──→ 006 ──┘    ↓
                              008
```

所有任务文件使用统一的frontmatter格式，包含完整的依赖关系、并行性标识和详细的实现指南，为后续开发执行提供了清晰的路线图。